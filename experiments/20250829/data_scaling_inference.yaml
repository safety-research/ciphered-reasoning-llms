experiment:
  table_name: encoding_schemes

  project_name: encoding_schemes
  experiment_name: datascaling_mathcot_sft_${encoding_scheme}_${model_id}

  experiment_params:
    model: ${model_id}
    encoding_scheme: ${encoding_scheme}

    dataset: numina_math_cot_512000
    validation_set_frac: 0.05

    sampling_params:
      temperature: 1.0
      n: 4

    sft_params:
      batch_size: 384
      learning_rate: 2e-6
      clip_grad: 1.0
      num_epochs: 1
      weight_decay: 0.0
      # preshuffled to maintain iid
      shuffle: False
      warmup_steps_ratio: 0.005
      lr_schedule: constant
      save_freq: 128

    translation_prompt: ${encoding_scheme}
    
    use_sft_model_for_sampling: True

  experiment_tags:

stages:

  - name: generate_math500_cot
    executor:
      path: speaking/encoded_cot_runner.py
      function_name: generate_prompted_translation
      function_kwargs:
        sampling_temperature_override: 0.5
    loop_for:
      template:
        model_path_override: output/__HASH__/sft_model/global_step___STEP__
        save_path_override: output/__HASH__/data/processed___STEP__/prompted_cot.parquet
      params:
        STEP: [3712]

    force_overwrite: True

  - name: evaluate_math_accuracy
    executor:
      path: evaluation/metrics/math_accuracy.py
      function_name: evaluate_math_accuracy
      function_kwargs: {}
    loop_for:
      template:
        input_path_override: output/__HASH__/data/processed___STEP__/prompted_cot.parquet
        output_path_override: output/__HASH__/data/processed___STEP__/math_scores.parquet
      params:
        STEP: [3712]

    force_overwrite: True

  - name: judge_cot_style_adherence
    executor:
      path: speaking/encoded_cot_runner.py
      function_name: judge_cot_style_adherence
      function_kwargs: {}
    loop_for:
      template:
        generated_cot_path_override: output/__HASH__/data/processed___STEP__/prompted_cot.parquet
      params:
        STEP: [3712]

    force_overwrite: True

  - name: generate_math500_reverse_translation
    executor:
      path: translation/run_reverse_translation.py
      function_name: generate_prompted_translation
      function_kwargs:
        skip_too_long: False
        reference_text_col: raw_translated_cot
        translated_text_col: reference_solution
        sampling_temperature_override: 0.5

    loop_for:
      template:
        model_path_override: output/__HASH__/sft_model/global_step___STEP__
        save_path_override: output/__HASH__/data/processed___STEP__/prompted_translation.parquet
      params:
        STEP: [3712]

    force_overwrite: True

  - name: evaluate_bleu_score
    executor:
      path: evaluation/metrics/translation.py
      function_name: evaluate_bleu_score
      function_kwargs: {}

    loop_for:
      template:
        translation_path_override: output/__HASH__/data/processed___STEP__/prompted_translation.parquet
        output_path_override: output/__HASH__/data/processed___STEP__/bleu_scores.parquet
      params:
        STEP: [3712]

    force_overwrite: True

  # - name: compute_validation_loss
  #   executor:
  #     path: sft/sft_runner.py
  #     function_name: get_sft_validation_loss_from_vllm
  #     function_kwargs: {}
  #   loop_for:
  #     template:
  #       model_path_override: output/__HASH__/sft_model/global_step___STEP__
  #       save_path_override: output/__HASH__/data/processed___STEP__/valid_logprobs.parquet
  #     params:
  #       STEP: [3712]

  - name: combine_all_result_dfs
    executor:
      path: utils/io_utils.py
      function_name: combine_translation_math_cot_dfs
      function_kwargs: {}

    loop_for:
      template:
        prompted_cot_path_override: output/__HASH__/data/processed___STEP__/prompted_cot.parquet
        math_scores_path_override: output/__HASH__/data/processed___STEP__/math_scores.parquet
        prompted_translation_path_override: output/__HASH__/data/processed___STEP__/prompted_translation.parquet
        bleu_scores_path_override: output/__HASH__/data/processed___STEP__/bleu_scores.parquet
        output_path_override: output/__HASH__/data/processed___STEP__/joined_output.parquet
      params:
        STEP: [3712]

    force_overwrite: True