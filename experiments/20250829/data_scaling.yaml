experiment:
  table_name: encoding_schemes

  project_name: encoding_schemes
  experiment_name: datascaling_mathcot_sft_${encoding_scheme}_${model_id}

  experiment_params:
    model: ${model_id}
    encoding_scheme: ${encoding_scheme}

    dataset: numina_math_cot_512000
    validation_set_frac: 0.05

    sampling_params:
      temperature: 1.0
      n: 4

    sft_params:
      batch_size: 384
      learning_rate: 2e-6
      clip_grad: 1.0
      num_epochs: 1
      weight_decay: 0.0
      # preshuffled to maintain iid
      shuffle: False
      warmup_steps_ratio: 0.005
      lr_schedule: constant
      save_freq: 128

    translation_prompt: ${encoding_scheme}
    
    use_sft_model_for_sampling: True

  experiment_tags:

stages:
  - name: generate_ground_truth_translation_cot
    executor:
      path: speaking/encoded_cot_runner.py
      function_name: generate_ground_truth_translation
      function_kwargs: {}

  - name: generate_sft_dataset_forward_translation
    executor:
      path: translation/run_translation.py
      function_name: generate_sft_dataset
      function_kwargs:
        skip_too_long: False
        reference_text_col: reference_solution
        translated_text_col: raw_translated_cot

  - name: copy_forward_translation
    executor:
      path: utils/io_utils.py
      function_name: copy_file
      function_kwargs:
        from_template: output/__HASH__/data/sft_train.parquet
        to_template: output/__HASH__/data/sft_translation_train.parquet
  
  - name: copy_forward_translation_valid
    executor:
      path: utils/io_utils.py
      function_name: copy_file
      function_kwargs:
        from_template: output/__HASH__/data/sft.parquet
        to_template: output/__HASH__/data/sft_translation.parquet

  - name: generate_sft_dataset_reverse_translation
    executor:
      path: translation/run_reverse_translation.py
      function_name: generate_sft_dataset
      function_kwargs:
        skip_too_long: False
        # Flipped for reverse translation...
        reference_text_col: raw_translated_cot
        translated_text_col: reference_solution

  - name: copy_reverse_translation
    executor:
      path: utils/io_utils.py
      function_name: copy_file
      function_kwargs:
        from_template: output/__HASH__/data/sft_train.parquet
        to_template: output/__HASH__/data/sft_backtranslation_train.parquet
  
  - name: copy_reverse_translation_valid
    executor:
      path: utils/io_utils.py
      function_name: copy_file
      function_kwargs:
        from_template: output/__HASH__/data/sft.parquet
        to_template: output/__HASH__/data/sft_backtranslation.parquet

  - name: generate_sft_dataset_cot
    executor:
      path: speaking/encoded_cot_runner.py
      function_name: generate_sft_dataset
      function_kwargs: {}


  - name: copy_cot_reasoning
    executor:
      path: utils/io_utils.py
      function_name: copy_file
      function_kwargs:
        from_template: output/__HASH__/data/sft_train.parquet
        to_template: output/__HASH__/data/sft_cot_train.parquet


  - name: copy_cot_reasoning_valid
    executor:
      path: utils/io_utils.py
      function_name: copy_file
      function_kwargs:
        from_template: output/__HASH__/data/sft.parquet
        to_template: output/__HASH__/data/sft_cot.parquet

  - name: combine_sft_files
    executor:
      path: utils/io_utils.py
      function_name: combine_parquet_files
      function_kwargs:
        to_template: output/__HASH__/data/sft_train.parquet
        index_lockstep: True
        translation_path: output/__HASH__/data/sft_translation_train.parquet
        backtranslation_path: output/__HASH__/data/sft_backtranslation_train.parquet
        cot_path: output/__HASH__/data/sft_cot_train.parquet

  - name: combine_sft_files_valid
    executor:
      path: utils/io_utils.py
      function_name: combine_parquet_files
      function_kwargs:
        to_template: output/__HASH__/data/sft.parquet
        index_lockstep: True
        translation_path: output/__HASH__/data/sft_translation.parquet
        backtranslation_path: output/__HASH__/data/sft_backtranslation.parquet
        cot_path: output/__HASH__/data/sft_cot.parquet

  - name: count_sft_tokens
    executor:
      path: utils/io_utils.py
      function_name: write_token_count
      function_kwargs: {}

  - name: generate_ground_truth_translation_math500_cot
    executor:
      path: speaking/encoded_cot_runner.py
      function_name: generate_ground_truth_translation
      function_kwargs:
        dataset_override: prm800k_test_raw
        validation_set_frac_override: 0.0

  - name: sft_model
    executor:
      path: sft/sft_runner.py
      function_name: sft_model
      function_kwargs:
        micro_batch_size_override: 4
        sft_model_override: output/__HASH__/sft_model/global_step_2432
    task_options:
      resources:
        long_running_job: 1

  # - name: do_test_all_reduce_bandwidth
  #   executor:
  #     path: sft/sft_runner.py
  #     function_name: multinode_sft_model
  #     function_kwargs:
  #       nnodes: 2
  #       do_test_all_reduce_bandwidth: True
  #   force_overwrite: True

  # - name: generate_math500_cot
  #   executor:
  #     path: speaking/encoded_cot_runner.py
  #     function_name: generate_prompted_translation
  #     function_kwargs: {}

  # - name: evaluate_math_accuracy
  #   executor:
  #     path: evaluation/metrics/math_accuracy.py
  #     function_name: evaluate_math_accuracy
  #     function_kwargs: {}

  # - name: judge_cot_style_adherence
  #   executor:
  #     path: speaking/encoded_cot_runner.py
  #     function_name: judge_cot_style_adherence
  #     function_kwargs: {}

  # - name: generate_math500_reverse_translation
  #   executor:
  #     path: translation/run_reverse_translation.py
  #     function_name: generate_prompted_translation
  #     function_kwargs:
  #       skip_too_long: False
  #       reference_text_col: raw_translated_cot
  #       translated_text_col: reference_solution

  # - name: evaluate_bleu_score
  #   executor:
  #     path: evaluation/metrics/translation.py
  #     function_name: evaluate_bleu_score
  #     function_kwargs: {}

  # - name: combine_all_result_dfs
  #   executor:
  #     path: utils/io_utils.py
  #     function_name: combine_translation_math_cot_dfs
  #     function_kwargs: {}